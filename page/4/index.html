<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="utf-8">
  

  
  <title>蓦然回首，bug依然在灯火阑珊处</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="记录一些资料，有原创也有摘录，防止以后会忘记。">
<meta name="keywords" content="后端 Node.js go golang">
<meta property="og:type" content="website">
<meta property="og:title" content="蓦然回首，bug依然在灯火阑珊处">
<meta property="og:url" content="http://yacen.github.io/page/4/index.html">
<meta property="og:site_name" content="蓦然回首，bug依然在灯火阑珊处">
<meta property="og:description" content="记录一些资料，有原创也有摘录，防止以后会忘记。">
<meta property="og:locale" content="Zh">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="蓦然回首，bug依然在灯火阑珊处">
<meta name="twitter:description" content="记录一些资料，有原创也有摘录，防止以后会忘记。">
  
    <link rel="alternate" href="/atom.xml" title="蓦然回首，bug依然在灯火阑珊处" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
</head>
</html>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">蓦然回首，bug依然在灯火阑珊处</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">记录平时可能用到的资料</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yacen.github.io"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-lodash/2018-3-15-lodash-array-compact、concat函数实现" class="article article-type-post" itemscope="" itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/03/15/lodash/2018-3-15-lodash-array-compact、concat函数实现/" class="article-date">
  <time datetime="2018-03-14T16:00:00.000Z" itemprop="datePublished">2018-03-15</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/nodejs/">nodejs</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/03/15/lodash/2018-3-15-lodash-array-compact、concat函数实现/">lodash-array-compact()/concat()函数实现</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>今天讲的是<code>compact()</code>/<code>concat()</code>函数。</p>
<h2 id="compact"><a href="#compact" class="headerlink" title="compact()"></a>compact()</h2><p>创建一个新数组，包含原数组中所有的非假值元素。例如false, null, 0, “”, undefined, 和 NaN 都是被认为是“假值”。</p>
<h3 id="我的实现是"><a href="#我的实现是" class="headerlink" title="我的实现是"></a>我的实现是</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">compact</span>(<span class="params">array</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(!array || !<span class="built_in">Array</span>.isArray(array) || array.length&lt;=<span class="number">0</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> [];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> array.filter(<span class="function"><span class="keyword">function</span> (<span class="params">value</span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(value) <span class="keyword">return</span> value;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我只是调用了es6语法中Array的filter实例方法，实现起来比较简单</p>
<h3 id="lodash的实现是："><a href="#lodash的实现是：" class="headerlink" title="lodash的实现是："></a>lodash的实现是：</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">compact</span>(<span class="params">array</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> index = <span class="number">-1</span>,</span><br><span class="line">      length = array == <span class="literal">null</span> ? <span class="number">0</span> : array.length,</span><br><span class="line">      resIndex = <span class="number">0</span>,</span><br><span class="line">      result = [];</span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> (++index &lt; length) &#123;</span><br><span class="line">    <span class="keyword">var</span> value = array[index];</span><br><span class="line">    <span class="keyword">if</span> (value) &#123;</span><br><span class="line">      result[resIndex++] = value;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>它是遍历整个数组，如果元素非假，就加入到<code>result</code>数组，最后返回<code>result</code>。</p>
<h2 id="concat"><a href="#concat" class="headerlink" title="concat()"></a>concat()</h2><p>创建一个新数组，将array与任何数组 或 值连接在一起。</p>
<h3 id="我的实现是-1"><a href="#我的实现是-1" class="headerlink" title="我的实现是"></a>我的实现是</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">concat</span>(<span class="params">array</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(!array || !<span class="built_in">Array</span>.isArray(array)|| array.length&lt;=<span class="number">0</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> [];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">arguments</span>.length&lt;=<span class="number">1</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> array.concat();</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">var</span> args=<span class="built_in">Array</span>.from(<span class="built_in">arguments</span>);</span><br><span class="line">        <span class="keyword">var</span> arg= args.splice(<span class="number">1</span>,<span class="number">1</span>);</span><br><span class="line">        args[<span class="number">0</span>]=array.concat(arg);</span><br><span class="line">        <span class="keyword">return</span> concat.apply(<span class="keyword">this</span>,args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我是用递归方法，每次通过<code>arguments</code>得到一个要连接的参数<code>arg</code>并移除，然后调用<code>array.concat(arg)</code>生成新的<code>array</code>，通过<code>concat.apply()</code>递归调用，直到没有要连接的参数为止。</p>
<h3 id="lodash的实现是：-1"><a href="#lodash的实现是：-1" class="headerlink" title="lodash的实现是："></a>lodash的实现是：</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">concat</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> length = <span class="built_in">arguments</span>.length;</span><br><span class="line">  <span class="keyword">if</span> (!length) &#123;</span><br><span class="line">    <span class="keyword">return</span> [];</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">var</span> args = <span class="built_in">Array</span>(length - <span class="number">1</span>),</span><br><span class="line">      array = <span class="built_in">arguments</span>[<span class="number">0</span>],</span><br><span class="line">      index = length;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> (index--) &#123;</span><br><span class="line">    args[index - <span class="number">1</span>] = <span class="built_in">arguments</span>[index];</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> arrayPush(isArray(array) ? copyArray(array) : [array], baseFlatten(args, <span class="number">1</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">arrayPush</span>(<span class="params">array, values</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> index = <span class="number">-1</span>,</span><br><span class="line">      length = values.length,</span><br><span class="line">      offset = array.length;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> (++index &lt; length) &#123;</span><br><span class="line">    array[offset + index] = values[index];</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> array;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>它没有用递归，主要逻辑在最后,先拷贝一份<code>array</code>，调用<code>arrayPush()</code>函数，<code>arrayPush()</code>函数的作用用一个循环，就往<code>array</code>上一个一个追加<code>values</code>。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yacen.github.io/2018/03/15/lodash/2018-3-15-lodash-array-compact、concat函数实现/" data-id="cjptlhd7q000hcxcp2zjf3vs2" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/lodash/">lodash</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-lodash/2018-3-14-lodash-array-chunk函数实现" class="article article-type-post" itemscope="" itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/03/14/lodash/2018-3-14-lodash-array-chunk函数实现/" class="article-date">
  <time datetime="2018-03-13T16:00:00.000Z" itemprop="datePublished">2018-03-14</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/nodejs/">nodejs</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/03/14/lodash/2018-3-14-lodash-array-chunk函数实现/">lodash-array-chunk函数实现</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><p>lodas包作为npm应用量最多的一个package，本人很好奇它有什么魅力，自己抽空用自己的逻辑写它的方法，并与它对比一下，收货蛮多的。</p>
<p>今天讲的是chunk函数。</p>
<p>将数组（array）拆分成多个 size 长度的区块，并将这些区块组成一个新数组。 如果array 无法被分割成全部等长的区块，那么最后剩余的元素将组成一个区块。</p>
<h2 id="我的实现是"><a href="#我的实现是" class="headerlink" title="我的实现是"></a>我的实现是</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">chunk</span>(<span class="params">array,size=<span class="number">1</span></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(!array||!<span class="built_in">Array</span>.isArray(array)||array.length&lt;=<span class="number">0</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> [];</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">var</span> result=[];</span><br><span class="line">        <span class="keyword">var</span> i=<span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span>(<span class="literal">true</span>)&#123;</span><br><span class="line">            result.push(array.slice(i,size+i));</span><br><span class="line">            i+=size;</span><br><span class="line">            <span class="keyword">if</span>(i&gt;=array.length)&#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="lodash的实现是："><a href="#lodash的实现是：" class="headerlink" title="lodash的实现是："></a>lodash的实现是：</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">chunk</span>(<span class="params">array, size, guard</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> ((guard ? isIterateeCall(array, size, guard) : size === <span class="literal">undefined</span>)) &#123;</span><br><span class="line">    size = <span class="number">1</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    size = nativeMax(toInteger(size), <span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">var</span> length = array == <span class="literal">null</span> ? <span class="number">0</span> : array.length;</span><br><span class="line">  <span class="keyword">if</span> (!length || size &lt; <span class="number">1</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> [];</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">var</span> index = <span class="number">0</span>,</span><br><span class="line">      resIndex = <span class="number">0</span>,</span><br><span class="line">      result = <span class="built_in">Array</span>(nativeCeil(length / size));</span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> (index &lt; length) &#123;</span><br><span class="line">    result[resIndex++] = baseSlice(array, index, (index += size));</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><p>大体思路差不多，只不过我用了es6语法的默认参数，<code>size</code>默认为<code>1</code>。</p>
<p>而lodash多传一个<code>guard</code>参数，中文翻译为守卫的意思，具体是什么含义呢？</p>
<p>如果不传<code>guard</code>，那就做 <code>size===undefined</code> 这个判断，如果<code>size</code>没传，<code>size=1</code>，如果传了<code>size</code>，那就把<code>size</code>转成整型，与0比较取最大值。</p>
<p>如果传了<code>guard</code>呢，那就会调用<code>isIterateeCall(array, size, guard)</code>,这个方法是干嘛的？</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">isIterateeCall</span>(<span class="params">value, index, object</span>) </span>&#123;</span><br><span class="line">  <span class="comment">//object不是对象就返回false</span></span><br><span class="line">  <span class="keyword">if</span> (!isObject(object)) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">var</span> type = <span class="keyword">typeof</span> index;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">if</span> (type == <span class="string">'number'</span></span><br><span class="line">        ? (isArrayLike(object) &amp;&amp; isIndex(index, object.length))</span><br><span class="line">        : (type == <span class="string">'string'</span> &amp;&amp; index <span class="keyword">in</span> object)</span><br><span class="line">      ) &#123;</span><br><span class="line">    <span class="comment">//index如果是数字的话，object是类数组对象并且index小于object的长度， 就返回eq(object[index], value)。如果index是字符串的话，index是object的属性，也返回eq(object[index], value)。</span></span><br><span class="line">    <span class="keyword">return</span> eq(object[index], value);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//其他情况一律返回false</span></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个函数官方注释是<code>Checks if the given arguments are from an iteratee call.</code>,也就说检查给的参数是否是来自一个迭代调用。</p>
<p>这就有意思了，验证下<code>array</code>是否是<code>guard</code>的一个成员变量。只有当<code>guard[size]===array</code>才把<code>size=1</code>，否则那就把<code>size</code>转成整型，与0比较取最大值。</p>
<p>后面的逻辑呢，都是首先验证下<code>array</code>，是否是空呀，长度是否为0呀，不合法的一律返回<code>[]</code>；接着就是循环的调用<code>slice</code>函数，我用的是原生的方法，而lodash是自己写的slice方法：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">baseSlice</span>(<span class="params">array, start, end</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> index = <span class="number">-1</span>,</span><br><span class="line">      length = array.length;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (start &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    start = -start &gt; length ? <span class="number">0</span> : (length + start);</span><br><span class="line">  &#125;</span><br><span class="line">  end = end &gt; length ? length : end;</span><br><span class="line">  <span class="keyword">if</span> (end &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    end += length;</span><br><span class="line">  &#125;</span><br><span class="line">  length = start &gt; end ? <span class="number">0</span> : ((end - start) &gt;&gt;&gt; <span class="number">0</span>);</span><br><span class="line">  start &gt;&gt;&gt;= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> result = <span class="built_in">Array</span>(length);</span><br><span class="line">  <span class="keyword">while</span> (++index &lt; length) &#123;</span><br><span class="line">    result[index] = array[index + start];</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>可以看出，lodash的哲学是一切都自己实现。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yacen.github.io/2018/03/14/lodash/2018-3-14-lodash-array-chunk函数实现/" data-id="cjptlhd7o000fcxcp8adkwhrl" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/lodash/">lodash</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-nginx/2018-03-06-Nginx安装" class="article article-type-post" itemscope="" itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/03/06/nginx/2018-03-06-Nginx安装/" class="article-date">
  <time datetime="2018-03-05T16:00:00.000Z" itemprop="datePublished">2018-03-06</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Nginx/">Nginx</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/03/06/nginx/2018-03-06-Nginx安装/">Nginx安装</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="Nginx安装有好几种方式："><a href="#Nginx安装有好几种方式：" class="headerlink" title="Nginx安装有好几种方式："></a>Nginx安装有好几种方式：</h2><h3 id="Debian-Ubuntu"><a href="#Debian-Ubuntu" class="headerlink" title="Debian/Ubuntu"></a>Debian/Ubuntu</h3><p><code>apt install nginx</code></p>
<h3 id="Red-CentOS"><a href="#Red-CentOS" class="headerlink" title="Red/CentOS"></a>Red/CentOS</h3><p><code>yum install nginx</code></p>
<h3 id="源码安装"><a href="#源码安装" class="headerlink" title="源码安装"></a>源码安装</h3><ol>
<li>从官网下载源码<br> 最好下 stable 稳定版本<code>wget https://nginx.org/download/nginx-1.4.7.tar.gz</code></li>
<li><p>解压<br> <code>tar -xzf nginx-1.4.7.tar.gz &amp;&amp; cd nginx-1.4.7</code></p>
<p> nginx源码目录是这样：</p>
<p> <code>auto  CHANGES  CHANGES.ru  conf  configure  contrib  html  LICENSE  man  README  src</code><br> CHANGES  CHANGES.ru 是nginx英文俄文写的版本历史<br> conf 是nginx的配置文件目录<br> html 是nginx默认的页面<br> man 是nginx手册<br> src 就是源码<br> configure和auto 是编译nginx所用到的文件</p>
</li>
<li><p>配置<br> <code>./configure --prefix=/usr/local/nginx</code><br> 中间可能需要安装 zlib pcre 等库</p>
</li>
<li>安装<br> <code>make &amp;&amp; make install &amp;&amp; cd /usr/local/nginx</code><br> nginx比较小，编译的很快</li>
<li>运行<br> <code>./sbin/nginx</code><br> <code>curl &#39;localhost&#39;</code><br> 如果能请求成公，则代表安装成功了</li>
</ol>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yacen.github.io/2018/03/06/nginx/2018-03-06-Nginx安装/" data-id="cjptlhd8j002qcxcples7muit" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-lodash/2018-3-21-lodash-array-fromPairs、flatten函数实现" class="article article-type-post" itemscope="" itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/03/02/lodash/2018-3-21-lodash-array-fromPairs、flatten函数实现/" class="article-date">
  <time datetime="2018-03-01T16:00:00.000Z" itemprop="datePublished">2018-03-02</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/nodejs/">nodejs</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/03/02/lodash/2018-3-21-lodash-array-fromPairs、flatten函数实现/">lodash-array-fromPairs\flatten函数实现</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>今天所实现的是<code>fromPairs()</code>函数。</p>
<h2 id="fromPairs"><a href="#fromPairs" class="headerlink" title="fromPairs()"></a>fromPairs()</h2><p>这个方法返回一个由键值对pairs构成的对象。</p>
<h3 id="我的实现是"><a href="#我的实现是" class="headerlink" title="我的实现是"></a>我的实现是</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">fromPairs</span>(<span class="params">pairs</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(!pairs||!<span class="built_in">Array</span>.isArray(pairs) || pairs.length&lt;=<span class="number">0</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> [];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">var</span> obj=&#123;&#125;;</span><br><span class="line">    pairs.forEach(<span class="function"><span class="params">val</span>=&gt;</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">Array</span>.isArray(val))&#123;</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">var</span> i=<span class="number">0</span>;i&lt;val.length;i+=<span class="number">2</span>)&#123;</span><br><span class="line">                obj[val[i]]=val[i+<span class="number">1</span>];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">return</span> obj;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>简单，看代码就能看懂。</p>
<h3 id="lodash的实现是："><a href="#lodash的实现是：" class="headerlink" title="lodash的实现是："></a>lodash的实现是：</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">fromPairs</span>(<span class="params">pairs</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> index = <span class="number">-1</span>,</span><br><span class="line">      length = pairs == <span class="literal">null</span> ? <span class="number">0</span> : pairs.length,</span><br><span class="line">      result = &#123;&#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> (++index &lt; length) &#123;</span><br><span class="line">    <span class="keyword">var</span> pair = pairs[index];</span><br><span class="line">    result[pair[<span class="number">0</span>]] = pair[<span class="number">1</span>];</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>不用说，差不多，不过我支持<code>[&#39;barney&#39;, 40, &#39;age&#39; , 10]</code>这种pairs。</p>
<h2 id="flattenDeep"><a href="#flattenDeep" class="headerlink" title="flattenDeep()"></a>flattenDeep()</h2><p>将array递归为一维数组。</p>
<h3 id="我的实现是-1"><a href="#我的实现是-1" class="headerlink" title="我的实现是"></a>我的实现是</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">flattenDeep</span>(<span class="params">array</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(!array || !<span class="built_in">Array</span>.isArray(array))&#123;</span><br><span class="line">        <span class="keyword">return</span> [];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">var</span> result=[];</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">addItem</span>(<span class="params">array</span>)</span>&#123;</span><br><span class="line">        array.forEach(<span class="function"><span class="params">element</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">if</span>(<span class="built_in">Array</span>.isArray(element))&#123;</span><br><span class="line">                addItem(element);</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                result.push(element);</span><br><span class="line">            &#125;  </span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    addItem(array);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>按照<code>flatten()</code>的思路，递归每一层，把不是数组的元素放到<code>result</code>数组中。</p>
<h3 id="lodash的实现是：-1"><a href="#lodash的实现是：-1" class="headerlink" title="lodash的实现是："></a>lodash的实现是：</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">flattenDeep</span>(<span class="params">array</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> length = array == <span class="literal">null</span> ? <span class="number">0</span> : array.length;</span><br><span class="line">  <span class="keyword">return</span> length ? baseFlatten(array, INFINITY) : [];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>也是调用<code>baseFlatten()</code>函数，只是参数不一样，这里传了<code>array</code>和 <code>INFINITY</code>。</p>
<h2 id="flattenDepth"><a href="#flattenDepth" class="headerlink" title="flattenDepth()"></a>flattenDepth()</h2><p>根据 depth 递归减少 array 的嵌套层级</p>
<h3 id="我的实现是："><a href="#我的实现是：" class="headerlink" title="我的实现是："></a>我的实现是：</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">flattenDepth</span>(<span class="params">array, depth = <span class="number">1</span></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!array || !<span class="built_in">Array</span>.isArray(array) || array.length &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> [];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">var</span> result=[];</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">addItem</span>(<span class="params">arr,dep</span>)</span>&#123;</span><br><span class="line">        arr.forEach(<span class="function"><span class="params">element</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">if</span>(<span class="built_in">Array</span>.isArray(element) &amp;&amp; dep&gt;<span class="number">0</span>)&#123;</span><br><span class="line">                addItem(element,dep<span class="number">-1</span>);</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                result.push(element);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    addItem(array,depth);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>递归函数<code>addItem()</code>多定义一个<code>dep</code>层级参数，每遍历一层就减1，减到0就直接加入<code>result</code>数组了。</p>
<h3 id="lodash的实现"><a href="#lodash的实现" class="headerlink" title="lodash的实现"></a>lodash的实现</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">flattenDepth</span>(<span class="params">array, depth</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> length = array == <span class="literal">null</span> ? <span class="number">0</span> : array.length;</span><br><span class="line">  <span class="keyword">if</span> (!length) &#123;</span><br><span class="line">    <span class="keyword">return</span> [];</span><br><span class="line">  &#125;</span><br><span class="line">  depth = depth === <span class="literal">undefined</span> ? <span class="number">1</span> : toInteger(depth);</span><br><span class="line">  <span class="keyword">return</span> baseFlatten(array, depth);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>调用<code>baseFlatten()</code>函数时传了<code>array</code>和 实际的<code>depth</code>。<code>baseFlatten()</code>如下：</p>
<h2 id="baseFlatten"><a href="#baseFlatten" class="headerlink" title="baseFlatten()"></a>baseFlatten()</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">baseFlatten</span>(<span class="params">array, depth, predicate, isStrict, result</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> index = <span class="number">-1</span>,</span><br><span class="line">      length = array.length;</span><br><span class="line"></span><br><span class="line">  predicate || (predicate = isFlattenable);</span><br><span class="line">  result || (result = []);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> (++index &lt; length) &#123;</span><br><span class="line">    <span class="keyword">var</span> value = array[index];</span><br><span class="line">    <span class="keyword">if</span> (depth &gt; <span class="number">0</span> &amp;&amp; predicate(value)) &#123;</span><br><span class="line">      <span class="keyword">if</span> (depth &gt; <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="comment">// Recursively flatten arrays (susceptible to call stack limits).</span></span><br><span class="line">        baseFlatten(value, depth - <span class="number">1</span>, predicate, isStrict, result);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        arrayPush(result, value);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!isStrict) &#123;</span><br><span class="line">      result[result.length] = value;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看出，lodash的思路和我差不多，也是在循环递归调用。我写的例子应该更好理解。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yacen.github.io/2018/03/02/lodash/2018-3-21-lodash-array-fromPairs、flatten函数实现/" data-id="cjptlhd7w0012cxcpt5buupio" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/lodash/">lodash</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-nginx/2018-03-00-Nginx介绍" class="article article-type-post" itemscope="" itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/02/28/nginx/2018-03-00-Nginx介绍/" class="article-date">
  <time datetime="2018-02-27T16:00:00.000Z" itemprop="datePublished">2018-02-28</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Nginx/">Nginx</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/02/28/nginx/2018-03-00-Nginx介绍/">Nginx介绍</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="Nginx安装有好几种方式："><a href="#Nginx安装有好几种方式：" class="headerlink" title="Nginx安装有好几种方式："></a>Nginx安装有好几种方式：</h2><p>Nginx 最初是作为一个 Web 服务器创建的，用于解决 C10k 的问题(C10K问题是指无法同时处理大量客户端(10,000)的网络套接字。)。</p>
<p>作为一个 Web 服务器，它可以以惊人的速度为您的数据服务。</p>
<p>但 Nginx 不仅仅是一个 Web 服务器，你还可以将其用作反向代理，与较慢的上游服务器（如：Unicorn 或 Puma）轻松集成。</p>
<p>你可以适当地分配流量（负载均衡器）、流媒体、动态调整图像大小、缓存内容等等。</p>
<p>基本的 nginx 体系结构由 master 进程和其 worker 进程组成。master 读取配置文件，并维护 worker 进程，而 worker 则会对请求进行实际处理。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yacen.github.io/2018/02/28/nginx/2018-03-00-Nginx介绍/" data-id="cjptlhd8d002hcxcpolfys6py" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-koa/2017-10-30-Response" class="article article-type-post" itemscope="" itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/10/30/koa/2017-10-30-Response/" class="article-date">
  <time datetime="2017-10-29T16:00:00.000Z" itemprop="datePublished">2017-10-30</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/nodejs/">nodejs</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/10/30/koa/2017-10-30-Response/">koa-Reponse</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="socket"><a href="#socket" class="headerlink" title="socket"></a>socket</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">get socket() &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">this</span>.ctx.req.socket;</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>
<p>response socket</p>
<h2 id="header"><a href="#header" class="headerlink" title="header"></a>header</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">get header() &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; res &#125; = <span class="keyword">this</span>;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">typeof</span> res.getHeaders === <span class="string">'function'</span></span><br><span class="line">    ? res.getHeaders()</span><br><span class="line">    : res._headers || &#123;&#125;;  <span class="comment">// Node &lt; 7.7</span></span><br><span class="line">&#125;,</span><br><span class="line"></span><br><span class="line">get headers() &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">this</span>.header;</span><br><span class="line">&#125;,</span><br><span class="line"></span><br><span class="line">get(field) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">this</span>.header[field.toLowerCase()] || <span class="string">''</span>;</span><br><span class="line">&#125;,</span><br><span class="line"></span><br><span class="line">set(field, val) &#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">this</span>.headerSent) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="number">2</span> == <span class="built_in">arguments</span>.length) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">Array</span>.isArray(val)) val = val.map(<span class="built_in">String</span>);</span><br><span class="line">    <span class="keyword">else</span> val = <span class="built_in">String</span>(val);</span><br><span class="line">    <span class="keyword">this</span>.res.setHeader(field, val);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> field) &#123;</span><br><span class="line">      <span class="keyword">this</span>.set(key, field[key]);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;,</span><br><span class="line"></span><br><span class="line">append(field, val) &#123;</span><br><span class="line">  <span class="keyword">const</span> prev = <span class="keyword">this</span>.get(field);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (prev) &#123;</span><br><span class="line">    val = <span class="built_in">Array</span>.isArray(prev)</span><br><span class="line">      ? prev.concat(val)</span><br><span class="line">      : [prev].concat(val);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">this</span>.set(field, val);</span><br><span class="line">&#125;,</span><br><span class="line"></span><br><span class="line">remove(field) &#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">this</span>.headerSent) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">this</span>.res.removeHeader(field);</span><br><span class="line">&#125;,</span><br><span class="line"></span><br><span class="line">get headerSent() &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">this</span>.res.headersSent;</span><br><span class="line">&#125;,</span><br><span class="line"></span><br><span class="line">vary(field) &#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">this</span>.headerSent) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">  vary(<span class="keyword">this</span>.res, field);</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>
<p>对 response header 的一系列方法。</p>
<h2 id="status-message"><a href="#status-message" class="headerlink" title="status/message"></a>status/message</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">get status() &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">this</span>.res.statusCode;</span><br><span class="line">&#125;,</span><br><span class="line"></span><br><span class="line">set status(code) &#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">this</span>.headerSent) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">  assert(<span class="string">'number'</span> == <span class="keyword">typeof</span> code, <span class="string">'status code must be a number'</span>);</span><br><span class="line">  assert(statuses[code], <span class="string">`invalid status code: <span class="subst">$&#123;code&#125;</span>`</span>);</span><br><span class="line">  <span class="keyword">this</span>._explicitStatus = <span class="literal">true</span>;</span><br><span class="line">  <span class="keyword">this</span>.res.statusCode = code;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">this</span>.req.httpVersionMajor &lt; <span class="number">2</span>) <span class="keyword">this</span>.res.statusMessage = statuses[code];</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">this</span>.body &amp;&amp; statuses.empty[code]) <span class="keyword">this</span>.body = <span class="literal">null</span>;</span><br><span class="line">&#125;,</span><br><span class="line"></span><br><span class="line">get message() &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">this</span>.res.statusMessage || statuses[<span class="keyword">this</span>.status];</span><br><span class="line">&#125;,</span><br><span class="line"></span><br><span class="line">set message(msg) &#123;</span><br><span class="line">  <span class="keyword">this</span>.res.statusMessage = msg;</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>
<p>对 response status 和 message 的 getter 和 setter</p>
<h2 id="body"><a href="#body" class="headerlink" title="body"></a>body</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">get body() &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">this</span>._body;</span><br><span class="line">&#125;,</span><br><span class="line"></span><br><span class="line">set body(val) &#123;</span><br><span class="line">  <span class="keyword">const</span> original = <span class="keyword">this</span>._body;</span><br><span class="line">  <span class="keyword">this</span>._body = val;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// no content</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="literal">null</span> == val) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!statuses.empty[<span class="keyword">this</span>.status]) <span class="keyword">this</span>.status = <span class="number">204</span>;</span><br><span class="line">    <span class="keyword">this</span>.remove(<span class="string">'Content-Type'</span>);</span><br><span class="line">    <span class="keyword">this</span>.remove(<span class="string">'Content-Length'</span>);</span><br><span class="line">    <span class="keyword">this</span>.remove(<span class="string">'Transfer-Encoding'</span>);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// set the status</span></span><br><span class="line">  <span class="keyword">if</span> (!<span class="keyword">this</span>._explicitStatus) <span class="keyword">this</span>.status = <span class="number">200</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// set the content-type only if not yet set</span></span><br><span class="line">  <span class="keyword">const</span> setType = !<span class="keyword">this</span>.header[<span class="string">'content-type'</span>];</span><br><span class="line"></span><br><span class="line">  <span class="comment">// string</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="string">'string'</span> == <span class="keyword">typeof</span> val) &#123;</span><br><span class="line">    <span class="keyword">if</span> (setType) <span class="keyword">this</span>.type = <span class="regexp">/^\s*&lt;/</span>.test(val) ? <span class="string">'html'</span> : <span class="string">'text'</span>;</span><br><span class="line">    <span class="keyword">this</span>.length = Buffer.byteLength(val);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// buffer</span></span><br><span class="line">  <span class="keyword">if</span> (Buffer.isBuffer(val)) &#123;</span><br><span class="line">    <span class="keyword">if</span> (setType) <span class="keyword">this</span>.type = <span class="string">'bin'</span>;</span><br><span class="line">    <span class="keyword">this</span>.length = val.length;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// stream</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="string">'function'</span> == <span class="keyword">typeof</span> val.pipe) &#123;</span><br><span class="line">    onFinish(<span class="keyword">this</span>.res, destroy.bind(<span class="literal">null</span>, val));</span><br><span class="line">    ensureErrorHandler(val, err =&gt; <span class="keyword">this</span>.ctx.onerror(err));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// overwriting</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">null</span> != original &amp;&amp; original != val) <span class="keyword">this</span>.remove(<span class="string">'Content-Length'</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (setType) <span class="keyword">this</span>.type = <span class="string">'bin'</span>;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// json</span></span><br><span class="line">  <span class="keyword">this</span>.remove(<span class="string">'Content-Length'</span>);</span><br><span class="line">  <span class="keyword">this</span>.type = <span class="string">'json'</span>;</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>
<p>response body getter 和 setter 方法</p>
<h2 id="length"><a href="#length" class="headerlink" title="length"></a>length</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">set length(n) &#123;</span><br><span class="line">  <span class="keyword">this</span>.set(<span class="string">'Content-Length'</span>, n);</span><br><span class="line">&#125;,</span><br><span class="line"></span><br><span class="line">get length() &#123;</span><br><span class="line">  <span class="keyword">const</span> len = <span class="keyword">this</span>.header[<span class="string">'content-length'</span>];</span><br><span class="line">  <span class="keyword">const</span> body = <span class="keyword">this</span>.body;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="literal">null</span> == len) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!body) <span class="keyword">return</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="string">'string'</span> == <span class="keyword">typeof</span> body) <span class="keyword">return</span> Buffer.byteLength(body);</span><br><span class="line">    <span class="keyword">if</span> (Buffer.isBuffer(body)) <span class="keyword">return</span> body.length;</span><br><span class="line">    <span class="keyword">if</span> (isJSON(body)) <span class="keyword">return</span> Buffer.byteLength(<span class="built_in">JSON</span>.stringify(body));</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> ~~len;</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>
<p>response Content-Length getter 和 setter 方法</p>
<h2 id="redirect"><a href="#redirect" class="headerlink" title="redirect"></a>redirect</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">redirect(url, alt) &#123;</span><br><span class="line">  <span class="comment">// location</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="string">'back'</span> == url) url = <span class="keyword">this</span>.ctx.get(<span class="string">'Referrer'</span>) || alt || <span class="string">'/'</span>;</span><br><span class="line">  <span class="keyword">this</span>.set(<span class="string">'Location'</span>, url);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// status</span></span><br><span class="line">  <span class="keyword">if</span> (!statuses.redirect[<span class="keyword">this</span>.status]) <span class="keyword">this</span>.status = <span class="number">302</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// html</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">this</span>.ctx.accepts(<span class="string">'html'</span>)) &#123;</span><br><span class="line">    url = <span class="built_in">escape</span>(url);</span><br><span class="line">    <span class="keyword">this</span>.type = <span class="string">'text/html; charset=utf-8'</span>;</span><br><span class="line">    <span class="keyword">this</span>.body = <span class="string">`Redirecting to &lt;a href="<span class="subst">$&#123;url&#125;</span>"&gt;<span class="subst">$&#123;url&#125;</span>&lt;/a&gt;.`</span>;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// text</span></span><br><span class="line">  <span class="keyword">this</span>.type = <span class="string">'text/plain; charset=utf-8'</span>;</span><br><span class="line">  <span class="keyword">this</span>.body = <span class="string">`Redirecting to <span class="subst">$&#123;url&#125;</span>.`</span>;</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>
<p>重定向到其他url</p>
<h2 id="Content-Disposition"><a href="#Content-Disposition" class="headerlink" title="Content-Disposition"></a>Content-Disposition</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Set Content-Disposition header to "attachment" with optional `filename`.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @param &#123;String&#125; filename</span></span><br><span class="line"><span class="comment"> * @api public</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line">attachment(filename) &#123;</span><br><span class="line">  <span class="keyword">if</span> (filename) <span class="keyword">this</span>.type = extname(filename);</span><br><span class="line">  <span class="keyword">this</span>.set(<span class="string">'Content-Disposition'</span>, contentDisposition(filename));</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>
<h2 id="Content-Type"><a href="#Content-Type" class="headerlink" title="Content-Type"></a>Content-Type</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">set type(type) &#123;</span><br><span class="line">  type = getType(type);</span><br><span class="line">  <span class="keyword">if</span> (type) &#123;</span><br><span class="line">    <span class="keyword">this</span>.set(<span class="string">'Content-Type'</span>, type);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">this</span>.remove(<span class="string">'Content-Type'</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>
<p>设置 Content-Type 方法</p>
<h2 id="lastModified-etag"><a href="#lastModified-etag" class="headerlink" title="lastModified/etag"></a>lastModified/etag</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">set lastModified(val) &#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="string">'string'</span> == <span class="keyword">typeof</span> val) val = <span class="keyword">new</span> <span class="built_in">Date</span>(val);</span><br><span class="line">  <span class="keyword">this</span>.set(<span class="string">'Last-Modified'</span>, val.toUTCString());</span><br><span class="line">&#125;,</span><br><span class="line"></span><br><span class="line">get lastModified() &#123;</span><br><span class="line">  <span class="keyword">const</span> date = <span class="keyword">this</span>.get(<span class="string">'last-modified'</span>);</span><br><span class="line">  <span class="keyword">if</span> (date) <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Date</span>(date);</span><br><span class="line">&#125;,</span><br><span class="line"></span><br><span class="line">set etag(val) &#123;</span><br><span class="line">  <span class="keyword">if</span> (!<span class="regexp">/^(W\/)?"/</span>.test(val)) val = <span class="string">`"<span class="subst">$&#123;val&#125;</span>"`</span>;</span><br><span class="line">  <span class="keyword">this</span>.set(<span class="string">'ETag'</span>, val);</span><br><span class="line">&#125;,</span><br><span class="line"></span><br><span class="line">get etag() &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">this</span>.get(<span class="string">'ETag'</span>);</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>
<p>lastModified 与 etag 的 getter 和 setter</p>
<h2 id="Content-Type-1"><a href="#Content-Type-1" class="headerlink" title="Content-Type"></a>Content-Type</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">get type() &#123;</span><br><span class="line">  <span class="keyword">const</span> type = <span class="keyword">this</span>.get(<span class="string">'Content-Type'</span>);</span><br><span class="line">  <span class="keyword">if</span> (!type) <span class="keyword">return</span> <span class="string">''</span>;</span><br><span class="line">  <span class="keyword">return</span> type.split(<span class="string">';'</span>)[<span class="number">0</span>];</span><br><span class="line">&#125;,</span><br><span class="line"></span><br><span class="line">is(types) &#123;</span><br><span class="line">  <span class="keyword">const</span> type = <span class="keyword">this</span>.type;</span><br><span class="line">  <span class="keyword">if</span> (!types) <span class="keyword">return</span> type || <span class="literal">false</span>;</span><br><span class="line">  <span class="keyword">if</span> (!<span class="built_in">Array</span>.isArray(types)) types = [].slice.call(<span class="built_in">arguments</span>);</span><br><span class="line">  <span class="keyword">return</span> typeis(type, types);</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://yacen.github.io/2017/10/30/koa/2017-10-30-Response/" data-id="cjptlhd7m000bcxcpdggi9832" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/koa/">koa</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-koa/2017-10-29-koa-Request" class="article article-type-post" itemscope="" itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/10/29/koa/2017-10-29-koa-Request/" class="article-date">
  <time datetime="2017-10-28T16:00:00.000Z" itemprop="datePublished">2017-10-29</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/nodejs/">nodejs</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/10/29/koa/2017-10-29-koa-Request/">koa-Request</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="Request"><a href="#Request" class="headerlink" title="Request"></a>Request</h2><p>Request 是koa包装了Node.js http 模块原生的 IncomingMessage ,也代理了它的常用方法，具体请看下文。</p>
<h2 id="header"><a href="#header" class="headerlink" title="header"></a>header</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">get header() &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">this</span>.req.headers;</span><br><span class="line">&#125;,</span><br><span class="line"></span><br><span class="line">set header(val) &#123;</span><br><span class="line">  <span class="keyword">this</span>.req.headers = val;</span><br><span class="line">&#125;,</span><br><span class="line"></span><br><span class="line">get headers() &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">this</span>.req.headers;</span><br><span class="line">&#125;,</span><br><span class="line"></span><br><span class="line">set headers(val) &#123;</span><br><span class="line">  <span class="keyword">this</span>.req.headers = val;</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>
<p>包装原生req对象的header setter 和 getter 便捷方法，四个方法其实只有两个方法，headers 是 header 的别名。</p>
<h2 id="url"><a href="#url" class="headerlink" title="url"></a>url</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">get url() &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">this</span>.req.url;</span><br><span class="line">&#125;,</span><br><span class="line"></span><br><span class="line">set url(val) &#123;</span><br><span class="line">  <span class="keyword">this</span>.req.url = val;</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>
<p>包装原生req对象的url setter 和 getter 便捷方法</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">get origin() &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">`<span class="subst">$&#123;<span class="keyword">this</span>.protocol&#125;</span>://<span class="subst">$&#123;<span class="keyword">this</span>.host&#125;</span>`</span>;</span><br><span class="line">&#125;,</span><br><span class="line"></span><br><span class="line">get href() &#123;</span><br><span class="line">  <span class="comment">// support: `GET http://example.com/foo`</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="regexp">/^https?:\/\//i</span>.test(<span class="keyword">this</span>.originalUrl)) <span class="keyword">return</span> <span class="keyword">this</span>.originalUrl;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">this</span>.origin + <span class="keyword">this</span>.originalUrl;</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>
<p><code>origin()</code> 返回 protocol + HOST ; <code>href()</code> 返回 origin + originalUrl</p>
<h2 id="memoizedURL"><a href="#memoizedURL" class="headerlink" title="memoizedURL"></a>memoizedURL</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">get URL() &#123;</span><br><span class="line">  <span class="keyword">if</span> (!<span class="keyword">this</span>.memoizedURL) &#123;</span><br><span class="line">    <span class="keyword">const</span> protocol = <span class="keyword">this</span>.protocol;</span><br><span class="line">    <span class="keyword">const</span> host = <span class="keyword">this</span>.host;</span><br><span class="line">    <span class="keyword">const</span> originalUrl = <span class="keyword">this</span>.originalUrl || <span class="string">''</span>; <span class="comment">// avoid undefined in template string</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">this</span>.memoizedURL = <span class="keyword">new</span> URL(<span class="string">`<span class="subst">$&#123;protocol&#125;</span>://<span class="subst">$&#123;host&#125;</span><span class="subst">$&#123;originalUrl&#125;</span>`</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">      <span class="keyword">this</span>.memoizedURL = <span class="built_in">Object</span>.create(<span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">this</span>.memoizedURL;</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>
<p>懒加载的url，由 protoco + ‘://‘ + host + originalUrl 组成。</p>
<h2 id="method"><a href="#method" class="headerlink" title="method"></a>method</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">get method() &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">this</span>.req.method;</span><br><span class="line">&#125;,</span><br><span class="line"></span><br><span class="line">set method(val) &#123;</span><br><span class="line">  <span class="keyword">this</span>.req.method = val;</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>
<p>包装原生req对象的method setter 和 getter 便捷方法</p>
<h2 id="path"><a href="#path" class="headerlink" title="path"></a>path</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Get request pathname.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @return &#123;String&#125;</span></span><br><span class="line"><span class="comment"> * @api public</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line">get path() &#123;</span><br><span class="line">  <span class="keyword">return</span> parse(<span class="keyword">this</span>.req).pathname;</span><br><span class="line">&#125;,</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Set pathname, retaining the query-string when present.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @param &#123;String&#125; path</span></span><br><span class="line"><span class="comment"> * @api public</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line">set path(path) &#123;</span><br><span class="line">  <span class="keyword">const</span> url = parse(<span class="keyword">this</span>.req);</span><br><span class="line">  <span class="keyword">if</span> (url.pathname === path) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">  url.pathname = path;</span><br><span class="line">  url.path = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">this</span>.url = stringify(url);</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>
<p><code>get path()</code>方法解析req的url并返回pathname，<code>set path(path)</code>方法先把 req.url 解析成对象，替换对象的pathname，然会返回字符串化的url对象。</p>
<h2 id="querystring"><a href="#querystring" class="headerlink" title="querystring"></a>querystring</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">get query() &#123;</span><br><span class="line">  <span class="keyword">const</span> str = <span class="keyword">this</span>.querystring;</span><br><span class="line">  <span class="keyword">const</span> c = <span class="keyword">this</span>._querycache = <span class="keyword">this</span>._querycache || &#123;&#125;;</span><br><span class="line">  <span class="keyword">return</span> c[str] || (c[str] = qs.parse(str));</span><br><span class="line">&#125;,</span><br><span class="line"></span><br><span class="line">set query(obj) &#123;</span><br><span class="line">  <span class="keyword">this</span>.querystring = qs.stringify(obj);</span><br><span class="line">&#125;,</span><br><span class="line"></span><br><span class="line">get querystring() &#123;</span><br><span class="line">  <span class="keyword">if</span> (!<span class="keyword">this</span>.req) <span class="keyword">return</span> <span class="string">''</span>;</span><br><span class="line">  <span class="keyword">return</span> parse(<span class="keyword">this</span>.req).query || <span class="string">''</span>;</span><br><span class="line">&#125;,</span><br><span class="line"></span><br><span class="line">set querystring(str) &#123;</span><br><span class="line">  <span class="keyword">const</span> url = parse(<span class="keyword">this</span>.req);</span><br><span class="line">  <span class="keyword">if</span> (url.search === <span class="string">`?<span class="subst">$&#123;str&#125;</span>`</span>) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">  url.search = str;</span><br><span class="line">  url.path = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">this</span>.url = stringify(url);</span><br><span class="line">&#125;,</span><br><span class="line"></span><br><span class="line">get search() &#123;</span><br><span class="line">  <span class="keyword">if</span> (!<span class="keyword">this</span>.querystring) <span class="keyword">return</span> <span class="string">''</span>;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">`?<span class="subst">$&#123;<span class="keyword">this</span>.querystring&#125;</span>`</span>;</span><br><span class="line">&#125;,</span><br><span class="line"></span><br><span class="line">set search(str) &#123;</span><br><span class="line">  <span class="keyword">this</span>.querystring = str;</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>
<p>一系列对 query 的 getter 和 setter 操作。search 也是 query 另一种是说法，其实一个意思。最终都是调用<code>get querystring()</code> 和 <code>set querystring(str)</code>。</p>
<h2 id="Host"><a href="#Host" class="headerlink" title="Host"></a>Host</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Parse the "Host" header field host</span></span><br><span class="line"><span class="comment"> * and support X-Forwarded-Host when a</span></span><br><span class="line"><span class="comment"> * proxy is enabled.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @return &#123;String&#125; hostname:port</span></span><br><span class="line"><span class="comment"> * @api public</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line">get host() &#123;</span><br><span class="line">  <span class="keyword">const</span> proxy = <span class="keyword">this</span>.app.proxy;</span><br><span class="line">  <span class="keyword">let</span> host = proxy &amp;&amp; <span class="keyword">this</span>.get(<span class="string">'X-Forwarded-Host'</span>);</span><br><span class="line">  host = host || <span class="keyword">this</span>.get(<span class="string">'Host'</span>);</span><br><span class="line">  <span class="keyword">if</span> (!host) <span class="keyword">return</span> <span class="string">''</span>;</span><br><span class="line">  <span class="keyword">return</span> host.split(<span class="regexp">/\s*,\s*/</span>)[<span class="number">0</span>];</span><br><span class="line">&#125;,</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Parse the "Host" header field hostname</span></span><br><span class="line"><span class="comment"> * and support X-Forwarded-Host when a</span></span><br><span class="line"><span class="comment"> * proxy is enabled.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @return &#123;String&#125; hostname</span></span><br><span class="line"><span class="comment"> * @api public</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line">get hostname() &#123;</span><br><span class="line">  <span class="keyword">const</span> host = <span class="keyword">this</span>.host;</span><br><span class="line">  <span class="keyword">if</span> (!host) <span class="keyword">return</span> <span class="string">''</span>;</span><br><span class="line">  <span class="keyword">if</span> (<span class="string">'['</span> == host[<span class="number">0</span>]) <span class="keyword">return</span> <span class="keyword">this</span>.URL.hostname || <span class="string">''</span>; <span class="comment">// IPv6</span></span><br><span class="line">  <span class="keyword">return</span> host.split(<span class="string">':'</span>)[<span class="number">0</span>];</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>
<p>解析 Host header 或者 X-Forwarded-Host header</p>
<h2 id="fresh-stale"><a href="#fresh-stale" class="headerlink" title="fresh/stale"></a>fresh/stale</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Check if the request is fresh, aka</span></span><br><span class="line"><span class="comment"> * Last-Modified and/or the ETag</span></span><br><span class="line"><span class="comment"> * still match.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @return &#123;Boolean&#125;</span></span><br><span class="line"><span class="comment"> * @api public</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line">get fresh() &#123;</span><br><span class="line">  <span class="keyword">const</span> method = <span class="keyword">this</span>.method;</span><br><span class="line">  <span class="keyword">const</span> s = <span class="keyword">this</span>.ctx.status;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// GET or HEAD for weak freshness validation only</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="string">'GET'</span> != method &amp;&amp; <span class="string">'HEAD'</span> != method) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 2xx or 304 as per rfc2616 14.26</span></span><br><span class="line">  <span class="keyword">if</span> ((s &gt;= <span class="number">200</span> &amp;&amp; s &lt; <span class="number">300</span>) || <span class="number">304</span> == s) &#123;</span><br><span class="line">    <span class="keyword">return</span> fresh(<span class="keyword">this</span>.header, <span class="keyword">this</span>.response.header);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;,</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Check if the request is stale, aka</span></span><br><span class="line"><span class="comment"> * "Last-Modified" and / or the "ETag" for the</span></span><br><span class="line"><span class="comment"> * resource has changed.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @return &#123;Boolean&#125;</span></span><br><span class="line"><span class="comment"> * @api public</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line">get stale() &#123;</span><br><span class="line">  <span class="keyword">return</span> !<span class="keyword">this</span>.fresh;</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>
<p>这两个方法名很有意思，新鲜的和陈腐的，其实就是缓存是否过期;</p>
<p>当一个request访问资源是否过期，response 带有 Last-Modified 或者 ETag header 时，判断是否过期</p>
<h2 id="idempotent（幂等）"><a href="#idempotent（幂等）" class="headerlink" title="idempotent（幂等）"></a>idempotent（幂等）</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">get idempotent() &#123;</span><br><span class="line">  <span class="keyword">const</span> methods = [<span class="string">'GET'</span>, <span class="string">'HEAD'</span>, <span class="string">'PUT'</span>, <span class="string">'DELETE'</span>, <span class="string">'OPTIONS'</span>, <span class="string">'TRACE'</span>];</span><br><span class="line">  <span class="keyword">return</span> !!~methods.indexOf(<span class="keyword">this</span>.method);</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>
<p>判断请求是否幂等，当 method 为 ‘GET’, ‘HEAD’, ‘PUT’, ‘DELETE’, ‘OPTIONS’, ‘TRACE’<br>时，就是幂等的</p>
<h2 id="request-socket"><a href="#request-socket" class="headerlink" title="request socket"></a>request socket</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">get socket() &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">this</span>.req.socket;</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>
<p>返回 request socket</p>
<p>charset<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">get charset() &#123;</span><br><span class="line">  <span class="keyword">let</span> type = <span class="keyword">this</span>.get(<span class="string">'Content-Type'</span>);</span><br><span class="line">  <span class="keyword">if</span> (!type) <span class="keyword">return</span> <span class="string">''</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    type = contentType.parse(type);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">''</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> type.parameters.charset || <span class="string">''</span>;</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure></p>
<p>返回 request 字符集</p>
<h2 id="length"><a href="#length" class="headerlink" title="length"></a>length</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">get length() &#123;</span><br><span class="line">  <span class="keyword">const</span> len = <span class="keyword">this</span>.get(<span class="string">'Content-Length'</span>);</span><br><span class="line">  <span class="keyword">if</span> (len == <span class="string">''</span>) <span class="keyword">return</span>;</span><br><span class="line">  <span class="keyword">return</span> ~~len;</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>
<p>返回 request length</p>
<h2 id="protocol"><a href="#protocol" class="headerlink" title="protocol"></a>protocol</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">get protocol() &#123;</span><br><span class="line">  <span class="keyword">const</span> proxy = <span class="keyword">this</span>.app.proxy;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">this</span>.socket.encrypted) <span class="keyword">return</span> <span class="string">'https'</span>;</span><br><span class="line">  <span class="keyword">if</span> (!proxy) <span class="keyword">return</span> <span class="string">'http'</span>;</span><br><span class="line">  <span class="keyword">const</span> proto = <span class="keyword">this</span>.get(<span class="string">'X-Forwarded-Proto'</span>) || <span class="string">'http'</span>;</span><br><span class="line">  <span class="keyword">return</span> proto.split(<span class="regexp">/\s*,\s*/</span>)[<span class="number">0</span>];</span><br><span class="line">&#125;,</span><br><span class="line"></span><br><span class="line">get secure() &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">'https'</span> == <span class="keyword">this</span>.protocol;</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>
<p>返回协议，http 或者 https。</p>
<h2 id="ips"><a href="#ips" class="headerlink" title="ips"></a>ips</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">get ips() &#123;</span><br><span class="line">  <span class="keyword">const</span> proxy = <span class="keyword">this</span>.app.proxy;</span><br><span class="line">  <span class="keyword">const</span> val = <span class="keyword">this</span>.get(<span class="string">'X-Forwarded-For'</span>);</span><br><span class="line">  <span class="keyword">return</span> proxy &amp;&amp; val</span><br><span class="line">    ? val.split(<span class="regexp">/\s*,\s*/</span>)</span><br><span class="line">    : [];</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>
<p>从 request 的 X-Forwarded-For header 获取ips</p>
<h2 id="subdomains"><a href="#subdomains" class="headerlink" title="subdomains"></a>subdomains</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Return subdomains as an array.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Subdomains are the dot-separated parts of the host before the main domain</span></span><br><span class="line"><span class="comment"> * of the app. By default, the domain of the app is assumed to be the last two</span></span><br><span class="line"><span class="comment"> * parts of the host. This can be changed by setting `app.subdomainOffset`.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * For example, if the domain is "tobi.ferrets.example.com":</span></span><br><span class="line"><span class="comment"> * If `app.subdomainOffset` is not set, this.subdomains is</span></span><br><span class="line"><span class="comment"> * `["ferrets", "tobi"]`.</span></span><br><span class="line"><span class="comment"> * If `app.subdomainOffset` is 3, this.subdomains is `["tobi"]`.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @return &#123;Array&#125;</span></span><br><span class="line"><span class="comment"> * @api public</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line">get subdomains() &#123;</span><br><span class="line">  <span class="keyword">const</span> offset = <span class="keyword">this</span>.app.subdomainOffset;</span><br><span class="line">  <span class="keyword">const</span> hostname = <span class="keyword">this</span>.hostname;</span><br><span class="line">  <span class="keyword">if</span> (net.isIP(hostname)) <span class="keyword">return</span> [];</span><br><span class="line">  <span class="keyword">return</span> hostname</span><br><span class="line">    .split(<span class="string">'.'</span>)</span><br><span class="line">    .reverse()</span><br><span class="line">    .slice(offset);</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>
<p>返回 子域名</p>
<h2 id="accept"><a href="#accept" class="headerlink" title="accept"></a>accept</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">accepts(...args) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">this</span>.accept.types(...args);</span><br><span class="line">&#125;,</span><br><span class="line"></span><br><span class="line">acceptsEncodings(...args) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">this</span>.accept.encodings(...args);</span><br><span class="line">&#125;,</span><br><span class="line"></span><br><span class="line">acceptsCharsets(...args) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">this</span>.accept.charsets(...args);</span><br><span class="line">&#125;,</span><br><span class="line"></span><br><span class="line">acceptsLanguages(...args) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">this</span>.accept.languages(...args);</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>
<p>关于 request Accept、Accept-language、Accept-Charset、Accept-Encoding 一些方法，</p>
<h2 id="Content-Type"><a href="#Content-Type" class="headerlink" title="Content-Type"></a>Content-Type</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">is(types) &#123;</span><br><span class="line">  <span class="keyword">if</span> (!types) <span class="keyword">return</span> typeis(<span class="keyword">this</span>.req);</span><br><span class="line">  <span class="keyword">if</span> (!<span class="built_in">Array</span>.isArray(types)) types = [].slice.call(<span class="built_in">arguments</span>);</span><br><span class="line">  <span class="keyword">return</span> typeis(<span class="keyword">this</span>.req, types);</span><br><span class="line">&#125;,</span><br><span class="line"></span><br><span class="line">get type() &#123;</span><br><span class="line">  <span class="keyword">const</span> type = <span class="keyword">this</span>.get(<span class="string">'Content-Type'</span>);</span><br><span class="line">  <span class="keyword">if</span> (!type) <span class="keyword">return</span> <span class="string">''</span>;</span><br><span class="line">  <span class="keyword">return</span> type.split(<span class="string">';'</span>)[<span class="number">0</span>];</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>
<p>关于 request Content-Type 一些方法，</p>
<h2 id="Other"><a href="#Other" class="headerlink" title="Other"></a>Other</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">get(field) &#123;</span><br><span class="line">  <span class="keyword">const</span> req = <span class="keyword">this</span>.req;</span><br><span class="line">  <span class="keyword">switch</span> (field = field.toLowerCase()) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'referer'</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'referrer'</span>:</span><br><span class="line">      <span class="keyword">return</span> req.headers.referrer || req.headers.referer || <span class="string">''</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      <span class="keyword">return</span> req.headers[field] || <span class="string">''</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>
<p>返回请求 header 信息。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yacen.github.io/2017/10/29/koa/2017-10-29-koa-Request/" data-id="cjptlhd980038cxcpjok394gy" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/koa/">koa</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-koa/2017-10-28-koa-Context" class="article article-type-post" itemscope="" itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/10/28/koa/2017-10-28-koa-Context/" class="article-date">
  <time datetime="2017-10-27T16:00:00.000Z" itemprop="datePublished">2017-10-28</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/nodejs/">nodejs</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/10/28/koa/2017-10-28-koa-Context/">koa-Context</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="Context"><a href="#Context" class="headerlink" title="Context"></a>Context</h2><p><code>context</code>对象是我们使用koa十分重要的一个环节，在<a href="2018-4-27-koa-Application.md">Application</a>中的<code>createContext(req, res)</code>方法里，在<code>context</code>对象上挂在了很多对象，koa的<code>request</code>和<code>response</code>对象、node原生的<code>req</code>和<code>res</code>对象、<code>app</code>对象、<code>originalUrl</code>、<code>cookies</code>、<code></code>accept<code>、</code>state`。它提供了处理请求与响应的所有接口，下面来看看它的源码。</p>
<h2 id="Context-prototype"><a href="#Context-prototype" class="headerlink" title="Context prototype"></a>Context prototype</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Context prototype.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> proto = <span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  ...</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>首先，它的注释写的是<code>Context prototype</code>,这个文件导出的是一个原型对象，<code>context</code>是通过<code>Object.create(context)</code>创建出来的。（<a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Object/create" target="_blank" rel="noopener">Object.create()</a>）</p>
<h2 id="其他方法"><a href="#其他方法" class="headerlink" title="其他方法"></a>其他方法</h2><p>其他方法比较简单，比如<code>throw()</code>、<code>onerror()</code>等，这里就不再多说。<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">throw</span>(...args) &#123;</span><br><span class="line">  <span class="keyword">throw</span> createError(...args);</span><br><span class="line">&#125;,</span><br><span class="line">onerror(err) &#123;</span><br><span class="line">  <span class="comment">// don't do anything if there is no error.</span></span><br><span class="line">  <span class="comment">// this allows you to pass `this.onerror`</span></span><br><span class="line">  <span class="comment">// to node-style callbacks.s allows you to pass `this.onerror`</span></span><br><span class="line">  <span class="comment">// to node-style callbacks.</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="literal">null</span> == err) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!(err <span class="keyword">instanceof</span> <span class="built_in">Error</span>)) err = <span class="keyword">new</span> <span class="built_in">Error</span>(util.format(<span class="string">'non-error thrown: %j'</span>, err));</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> headerSent = <span class="literal">false</span>;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">this</span>.headerSent || !<span class="keyword">this</span>.writable) &#123;</span><br><span class="line">    headerSent = err.headerSent = <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// delegate</span></span><br><span class="line">  <span class="keyword">this</span>.app.emit(<span class="string">'error'</span>, err, <span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// nothing we can do here other</span></span><br><span class="line">  <span class="comment">// than delegate to the app-level</span></span><br><span class="line">  <span class="comment">// handler and log.</span></span><br><span class="line">  <span class="keyword">if</span> (headerSent) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> &#123; res &#125; = <span class="keyword">this</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// first unset all headers</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> res.getHeaderNames === <span class="string">'function'</span>) &#123;</span><br><span class="line">    res.getHeaderNames().forEach(<span class="function"><span class="params">name</span> =&gt;</span> res.removeHeader(name));</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    res._headers = &#123;&#125;; <span class="comment">// Node &lt; 7.7</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// then set those specified</span></span><br><span class="line">  <span class="keyword">this</span>.set(err.headers);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// force text/plain</span></span><br><span class="line">  <span class="keyword">this</span>.type = <span class="string">'text'</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ENOENT support</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="string">'ENOENT'</span> == err.code) err.status = <span class="number">404</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// default to 500</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="string">'number'</span> != <span class="keyword">typeof</span> err.status || !statuses[err.status]) err.status = <span class="number">500</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// respond</span></span><br><span class="line">  <span class="keyword">const</span> code = statuses[err.status];</span><br><span class="line">  <span class="keyword">const</span> msg = err.expose ? err.message : code;</span><br><span class="line">  <span class="keyword">this</span>.status = err.status;</span><br><span class="line">  <span class="keyword">this</span>.length = Buffer.byteLength(msg);</span><br><span class="line">  <span class="keyword">this</span>.res.end(msg);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="delegate"><a href="#delegate" class="headerlink" title="delegate"></a>delegate</h2><p>context的精髓主要在于代理了request和response的一些常用方法，看代码：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> delegate = <span class="built_in">require</span>(<span class="string">'delegates'</span>);</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Response delegation.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line">delegate(proto, <span class="string">'response'</span>)</span><br><span class="line">  .method(<span class="string">'attachment'</span>)</span><br><span class="line">  .method(<span class="string">'redirect'</span>)</span><br><span class="line">  .method(<span class="string">'remove'</span>)</span><br><span class="line">  .method(<span class="string">'vary'</span>)</span><br><span class="line">  .method(<span class="string">'set'</span>)</span><br><span class="line">  .method(<span class="string">'append'</span>)</span><br><span class="line">  .method(<span class="string">'flushHeaders'</span>)</span><br><span class="line">  .access(<span class="string">'status'</span>)</span><br><span class="line">  .access(<span class="string">'message'</span>)</span><br><span class="line">  .access(<span class="string">'body'</span>)</span><br><span class="line">  .access(<span class="string">'length'</span>)</span><br><span class="line">  .access(<span class="string">'type'</span>)</span><br><span class="line">  .access(<span class="string">'lastModified'</span>)</span><br><span class="line">  .access(<span class="string">'etag'</span>)</span><br><span class="line">  .getter(<span class="string">'headerSent'</span>)</span><br><span class="line">  .getter(<span class="string">'writable'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Request delegation.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line">delegate(proto, <span class="string">'request'</span>)</span><br><span class="line">  .method(<span class="string">'acceptsLanguages'</span>)</span><br><span class="line">  .method(<span class="string">'acceptsEncodings'</span>)</span><br><span class="line">  .method(<span class="string">'acceptsCharsets'</span>)</span><br><span class="line">  .method(<span class="string">'accepts'</span>)</span><br><span class="line">  .method(<span class="string">'get'</span>)</span><br><span class="line">  .method(<span class="string">'is'</span>)</span><br><span class="line">  .access(<span class="string">'querystring'</span>)</span><br><span class="line">  .access(<span class="string">'idempotent'</span>)</span><br><span class="line">  .access(<span class="string">'socket'</span>)</span><br><span class="line">  .access(<span class="string">'search'</span>)</span><br><span class="line">  .access(<span class="string">'method'</span>)</span><br><span class="line">  .access(<span class="string">'query'</span>)</span><br><span class="line">  .access(<span class="string">'path'</span>)</span><br><span class="line">  .access(<span class="string">'url'</span>)</span><br><span class="line">  .getter(<span class="string">'origin'</span>)</span><br><span class="line">  .getter(<span class="string">'href'</span>)</span><br><span class="line">  .getter(<span class="string">'subdomains'</span>)</span><br><span class="line">  .getter(<span class="string">'protocol'</span>)</span><br><span class="line">  .getter(<span class="string">'host'</span>)</span><br><span class="line">  .getter(<span class="string">'hostname'</span>)</span><br><span class="line">  .getter(<span class="string">'URL'</span>)</span><br><span class="line">  .getter(<span class="string">'header'</span>)</span><br><span class="line">  .getter(<span class="string">'headers'</span>)</span><br><span class="line">  .getter(<span class="string">'secure'</span>)</span><br><span class="line">  .getter(<span class="string">'stale'</span>)</span><br><span class="line">  .getter(<span class="string">'fresh'</span>)</span><br><span class="line">  .getter(<span class="string">'ips'</span>)</span><br><span class="line">  .getter(<span class="string">'ip'</span>);</span><br></pre></td></tr></table></figure></p>
<p>这样就为程序员提供了更简洁的调用方式。主要实现方法在<code>delegates</code>库里，咱们来瞅瞅。</p>
<h3 id="delegates"><a href="#delegates" class="headerlink" title="delegates"></a>delegates</h3><p>这是一个Nodejs 方法和属性 代理工具库。</p>
<h4 id="构造函数"><a href="#构造函数" class="headerlink" title="构造函数"></a>构造函数</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = Delegator;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Delegator</span>(<span class="params">proto, target</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!(<span class="keyword">this</span> <span class="keyword">instanceof</span> Delegator)) <span class="keyword">return</span> <span class="keyword">new</span> Delegator(proto, target);</span><br><span class="line">  <span class="keyword">this</span>.proto = proto;</span><br><span class="line">  <span class="keyword">this</span>.target = target;</span><br><span class="line">  <span class="keyword">this</span>.methods = [];</span><br><span class="line">  <span class="keyword">this</span>.getters = [];</span><br><span class="line">  <span class="keyword">this</span>.setters = [];</span><br><span class="line">  <span class="keyword">this</span>.fluents = [];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这种构造函数相当于一个工厂方法，快速创建一个<code>Delegator</code>对象。有一个成员属性，<code>proto</code>是代理对象，<code>target</code>是被代理的对象，<code>methods</code>数组用来存放方法名，<code>getters</code>和<code>setters</code>数组用来存放属性的accessors，<code>fluents</code>数组用来存放属性。<br>（<a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Object/__defineGetter__" target="_blank" rel="noopener"><strong>defineGetter</strong></a>和<a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Object/__defineSetter__" target="_blank" rel="noopener"><strong>defineSetter</strong></a>）</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">Delegator.prototype.method = <span class="function"><span class="keyword">function</span>(<span class="params">name</span>)</span>&#123;</span><br><span class="line">  <span class="keyword">var</span> proto = <span class="keyword">this</span>.proto;</span><br><span class="line">  <span class="keyword">var</span> target = <span class="keyword">this</span>.target;</span><br><span class="line">  <span class="keyword">this</span>.methods.push(name);</span><br><span class="line"></span><br><span class="line">  proto[name] = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>[target][name].apply(<span class="keyword">this</span>[target], <span class="built_in">arguments</span>);</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">Delegator.prototype.access = <span class="function"><span class="keyword">function</span>(<span class="params">name</span>)</span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">this</span>.getter(name).setter(name);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">Delegator.prototype.getter = <span class="function"><span class="keyword">function</span>(<span class="params">name</span>)</span>&#123;</span><br><span class="line">  <span class="keyword">var</span> proto = <span class="keyword">this</span>.proto;</span><br><span class="line">  <span class="keyword">var</span> target = <span class="keyword">this</span>.target;</span><br><span class="line">  <span class="keyword">this</span>.getters.push(name);</span><br><span class="line"></span><br><span class="line">  proto.__defineGetter__(name, <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>[target][name];</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">Delegator.prototype.setter = <span class="function"><span class="keyword">function</span>(<span class="params">name</span>)</span>&#123;</span><br><span class="line">  <span class="keyword">var</span> proto = <span class="keyword">this</span>.proto;</span><br><span class="line">  <span class="keyword">var</span> target = <span class="keyword">this</span>.target;</span><br><span class="line">  <span class="keyword">this</span>.setters.push(name);</span><br><span class="line"></span><br><span class="line">  proto.__defineSetter__(name, <span class="function"><span class="keyword">function</span>(<span class="params">val</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>[target][name] = val;</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">Delegator.prototype.fluent = <span class="function"><span class="keyword">function</span> (<span class="params">name</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> proto = <span class="keyword">this</span>.proto;</span><br><span class="line">  <span class="keyword">var</span> target = <span class="keyword">this</span>.target;</span><br><span class="line">  <span class="keyword">this</span>.fluents.push(name);</span><br><span class="line"></span><br><span class="line">  proto[name] = <span class="function"><span class="keyword">function</span>(<span class="params">val</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="string">'undefined'</span> != <span class="keyword">typeof</span> val) &#123;</span><br><span class="line">      <span class="keyword">this</span>[target][name] = val;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">this</span>[target][name];</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://yacen.github.io/2017/10/28/koa/2017-10-28-koa-Context/" data-id="cjptlhd7l000acxcplmrqwy6a" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/koa/">koa</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-koa/2017-10-17-koa-Application" class="article article-type-post" itemscope="" itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/10/17/koa/2017-10-17-koa-Application/" class="article-date">
  <time datetime="2017-10-16T16:00:00.000Z" itemprop="datePublished">2017-10-17</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/nodejs/">nodejs</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/10/17/koa/2017-10-17-koa-Application/">koa-Application</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="引子"><a href="#引子" class="headerlink" title="引子"></a>引子</h3><p>koa应该是如今node.js网络框架用的最多的一款了，它与Express类似用中间件的形式把功能封装封装成独立的模块，了解过Java开发的同学应该可以想到类似于JavaEE中的Servlet和Filter这种处理流模式，也有些人很形象的说它是一种洋葱形式的结构。</p>
<p>koa不仅仅这些。nodejs中异步代码应该是最常见的，时不时来一个异步回调，多层异步回调嵌套就使得代码看能起来很恶心。在v1.x版本使用ES6的generator函数来来解决这个问题，v2.x使用更高大上的async/await来实现异步调用，让代码很好看。</p>
<p>为了学习，我来分析下koa的源码。</p>
<p>koa源码很简单，就四个js文件：application.js、context.js、request.js 和 response.js。</p>
<p>今天来看看<code>application.js</code>吧。</p>
<h3 id="Application"><a href="#Application" class="headerlink" title="Application"></a>Application</h3><h4 id="一般，我们使用koa会写如下代码："><a href="#一般，我们使用koa会写如下代码：" class="headerlink" title="一般，我们使用koa会写如下代码："></a>一般，我们使用koa会写如下代码：</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> Koa=<span class="built_in">require</span>(<span class="string">'koa'</span>);</span><br><span class="line"><span class="keyword">const</span> app=<span class="keyword">new</span> Koa();</span><br><span class="line"></span><br><span class="line">app.use(<span class="keyword">async</span> ctx=&gt;&#123;</span><br><span class="line">  ctx.body=<span class="string">'hello world'</span>);</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.listen(<span class="number">3000</span>);</span><br></pre></td></tr></table></figure>
<h4 id="从使用中就可以知道，koa导出的是一个构造函数，果然是这样："><a href="#从使用中就可以知道，koa导出的是一个构造函数，果然是这样：" class="headerlink" title="从使用中就可以知道，koa导出的是一个构造函数，果然是这样："></a>从使用中就可以知道，koa导出的是一个构造函数，果然是这样：</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = <span class="class"><span class="keyword">class</span> <span class="title">Application</span> <span class="keyword">extends</span> <span class="title">Emitter</span> </span>&#123;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="可以看出它继承了Emitter，"><a href="#可以看出它继承了Emitter，" class="headerlink" title="可以看出它继承了Emitter，"></a>可以看出它继承了<code>Emitter</code>，</h4><p>这是node.js的核心模块<code>events</code>，<code>events</code>是什么都知道，简单来说就是消息的订阅与发送。当我要想监听应用是否启动成功，可以添加一下代码：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">app.on(<span class="string">'error'</span>,<span class="function"><span class="keyword">function</span>(<span class="params">e</span>)</span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(e);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<h4 id="再来看看构造器："><a href="#再来看看构造器：" class="headerlink" title="再来看看构造器："></a>再来看看构造器：</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">constructor</span>() &#123;</span><br><span class="line">  <span class="keyword">super</span>();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">this</span>.proxy = <span class="literal">false</span>;</span><br><span class="line">  <span class="keyword">this</span>.middleware = [];</span><br><span class="line">  <span class="keyword">this</span>.subdomainOffset = <span class="number">2</span>;</span><br><span class="line">  <span class="keyword">this</span>.env = process.env.NODE_ENV || <span class="string">'development'</span>;</span><br><span class="line">  <span class="keyword">this</span>.context = <span class="built_in">Object</span>.create(context);</span><br><span class="line">  <span class="keyword">this</span>.request = <span class="built_in">Object</span>.create(request);</span><br><span class="line">  <span class="keyword">this</span>.response = <span class="built_in">Object</span>.create(response);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>proxy</code>、<code>subdomainOffset</code>暂不知道干嘛用的；<code>middleware</code>是用来承载所有中间件的数组；<code>env</code>是程序是执行环境；<code>context</code>代表上下文；<code>request</code>代表请求；<code>response</code>代表响应。</p>
<h4 id="listen"><a href="#listen" class="headerlink" title="listen()"></a>listen()</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">listen(...args) &#123;</span><br><span class="line">  debug(<span class="string">'listen'</span>);</span><br><span class="line">  <span class="keyword">const</span> server = http.createServer(<span class="keyword">this</span>.callback());</span><br><span class="line">  <span class="keyword">return</span> server.listen(...args);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>listen()</code>包装了<code>http</code>,做了一个快捷方法，<code>http</code>接受的回调函数在<code>callback()</code>里面定义</p>
<h4 id="callback"><a href="#callback" class="headerlink" title="callback()"></a>callback()</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">callback() &#123;</span><br><span class="line">  <span class="keyword">const</span> fn = compose(<span class="keyword">this</span>.middleware);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!<span class="keyword">this</span>.listeners(<span class="string">'error'</span>).length) <span class="keyword">this</span>.on(<span class="string">'error'</span>, <span class="keyword">this</span>.onerror);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> handleRequest = <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> ctx = <span class="keyword">this</span>.createContext(req, res);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.handleRequest(ctx, fn);</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> handleRequest;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>首先它会<code>compose</code>所有的中间件，然后监听<code>error</code>事件，然后定义并返回<code>handleRequest</code>函数。</p>
<p><code>handleRequest</code>函数就是<code>http.createServer(?)</code>的回调函数;</p>
<p><code>handleRequest</code>每次来一个请求都会创建一个<code>ctx</code>，并且调用<code>this.handleRequest(ctx, fn)</code></p>
<h4 id="onerror-err"><a href="#onerror-err" class="headerlink" title="onerror(err)"></a>onerror(err)</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">onerror(err) &#123;</span><br><span class="line">  assert(err <span class="keyword">instanceof</span> <span class="built_in">Error</span>, <span class="string">`non-error thrown: <span class="subst">$&#123;err&#125;</span>`</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="number">404</span> == err.status || err.expose) <span class="keyword">return</span>;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">this</span>.silent) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> msg = err.stack || err.toString();</span><br><span class="line">  <span class="built_in">console</span>.error();</span><br><span class="line">  <span class="built_in">console</span>.error(msg.replace(<span class="regexp">/^/gm</span>, <span class="string">'  '</span>));</span><br><span class="line">  <span class="built_in">console</span>.error();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>系统默认的错误处理程序。如果设置了<code>silent = true</code>，则不会在控制台打印出error。</p>
<h4 id="createContext-req-res"><a href="#createContext-req-res" class="headerlink" title="createContext(req, res)"></a>createContext(req, res)</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">createContext(req, res) &#123;</span><br><span class="line">  <span class="keyword">const</span> context = <span class="built_in">Object</span>.create(<span class="keyword">this</span>.context);</span><br><span class="line">  <span class="keyword">const</span> request = context.request = <span class="built_in">Object</span>.create(<span class="keyword">this</span>.request);</span><br><span class="line">  <span class="keyword">const</span> response = context.response = <span class="built_in">Object</span>.create(<span class="keyword">this</span>.response);</span><br><span class="line">  context.app = request.app = response.app = <span class="keyword">this</span>;</span><br><span class="line">  context.req = request.req = response.req = req;</span><br><span class="line">  context.res = request.res = response.res = res;</span><br><span class="line">  request.ctx = response.ctx = context;</span><br><span class="line">  request.response = response;</span><br><span class="line">  response.request = request;</span><br><span class="line">  context.originalUrl = request.originalUrl = req.url;</span><br><span class="line">  context.cookies = <span class="keyword">new</span> Cookies(req, res, &#123;</span><br><span class="line">    keys: <span class="keyword">this</span>.keys,</span><br><span class="line">    secure: request.secure</span><br><span class="line">  &#125;);</span><br><span class="line">  request.ip = request.ips[<span class="number">0</span>] || req.socket.remoteAddress || <span class="string">''</span>;</span><br><span class="line">  context.accept = request.accept = accepts(req);</span><br><span class="line">  context.state = &#123;&#125;;</span><br><span class="line">  <span class="keyword">return</span> context;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>就是创建<code>context</code> <code>request</code> <code>response</code> 对象，并在其上挂载一些便捷的访问入口。</p>
<h4 id="handleRequest-ctx-fnMiddleware"><a href="#handleRequest-ctx-fnMiddleware" class="headerlink" title="handleRequest(ctx, fnMiddleware)"></a>handleRequest(ctx, fnMiddleware)</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">handleRequest(ctx, fnMiddleware) &#123;</span><br><span class="line">  <span class="keyword">const</span> res = ctx.res;</span><br><span class="line">  res.statusCode = <span class="number">404</span>;</span><br><span class="line">  <span class="keyword">const</span> onerror = <span class="function"><span class="params">err</span> =&gt;</span> ctx.onerror(err);</span><br><span class="line">  <span class="keyword">const</span> handleResponse = <span class="function"><span class="params">()</span> =&gt;</span> respond(ctx);</span><br><span class="line">  onFinished(res, onerror);</span><br><span class="line">  <span class="keyword">return</span> fnMiddleware(ctx).then(handleResponse).catch(onerror);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这就是处理请求的函数，首先一上来默认把<code>statusCode</code>改为<code>404</code>，设置错误回调处理逻辑<code>onerror</code>和处理响应逻辑<code>handleResponse</code>，监听<code>onFinished</code>事件，然后调用中间件函数。中间件执行成功就调用<code>handleResponse</code>,失败就调用<code>onerror</code>。</p>
<h4 id="respond-ctx"><a href="#respond-ctx" class="headerlink" title="respond(ctx);"></a>respond(ctx);</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">respond</span>(<span class="params">ctx</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 如果设置ctx.respond=false，则取消koa默认响应</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="literal">false</span> === ctx.respond) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> res = ctx.res;</span><br><span class="line">  <span class="comment">// 如果ctx.writable=false，取消响应。</span></span><br><span class="line">  <span class="keyword">if</span> (!ctx.writable) <span class="keyword">return</span>;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">let</span> body = ctx.body;</span><br><span class="line">  <span class="keyword">const</span> code = ctx.status;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// statuscode为204、205、304时，去除body，直接结束</span></span><br><span class="line">  <span class="keyword">if</span> (statuses.empty[code]) &#123;</span><br><span class="line">    <span class="keyword">return</span> res.end();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// HEAD访问，计算出长度，返回</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="string">'HEAD'</span> == ctx.method) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!res.headersSent &amp;&amp; isJSON(body)) &#123;</span><br><span class="line">      ctx.length = Buffer.byteLength(<span class="built_in">JSON</span>.stringify(body));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> res.end();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// body为null，默认返回message或者statuscode</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="literal">null</span> == body) &#123;</span><br><span class="line">    body = ctx.message || <span class="built_in">String</span>(code);</span><br><span class="line">    <span class="keyword">if</span> (!res.headersSent) &#123;</span><br><span class="line">      ctx.type = <span class="string">'text'</span>;</span><br><span class="line">      ctx.length = Buffer.byteLength(body);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> res.end(body);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// body为buffer，返回body</span></span><br><span class="line">  <span class="keyword">if</span> (Buffer.isBuffer(body)) <span class="keyword">return</span> res.end(body);</span><br><span class="line">  <span class="comment">// body为string，返回body</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="string">'string'</span> == <span class="keyword">typeof</span> body) <span class="keyword">return</span> res.end(body);</span><br><span class="line">  <span class="comment">// body为Stream，pipe这个body</span></span><br><span class="line">  <span class="keyword">if</span> (body <span class="keyword">instanceof</span> Stream) <span class="keyword">return</span> body.pipe(res);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// body为json，字符串化，计算长度后返回</span></span><br><span class="line">  body = <span class="built_in">JSON</span>.stringify(body);</span><br><span class="line">  <span class="keyword">if</span> (!res.headersSent) &#123;</span><br><span class="line">    ctx.length = Buffer.byteLength(body);</span><br><span class="line">  &#125;</span><br><span class="line">  res.end(body);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>根据不同的情况走不同的逻辑，最终都是以<code>res.end();</code>结束。</p>
<h4 id="use-fn"><a href="#use-fn" class="headerlink" title="use(fn)"></a>use(fn)</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">use(fn) &#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> fn !== <span class="string">'function'</span>) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">TypeError</span>(<span class="string">'middleware must be a function!'</span>);</span><br><span class="line">  <span class="keyword">if</span> (isGeneratorFunction(fn)) &#123;</span><br><span class="line">    deprecate(<span class="string">'Support for generators will be removed in v3. '</span> +</span><br><span class="line">              <span class="string">'See the documentation for examples of how to convert old middleware '</span> +</span><br><span class="line">              <span class="string">'https://github.com/koajs/koa/blob/master/docs/migration.md'</span>);</span><br><span class="line">    fn = convert(fn);</span><br><span class="line">  &#125;</span><br><span class="line">  debug(<span class="string">'use %s'</span>, fn._name || fn.name || <span class="string">'-'</span>);</span><br><span class="line">  <span class="keyword">this</span>.middleware.push(fn);</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个就是向koa添加中间件的方法，先判断 fn 是否是<code>function</code>，不是就直接抛异常；</p>
<p>在判断 fn 是否是<code>generator</code>，是的话用<code>convert</code>包装成普通function；</p>
<p>这时 fn 要么是普通function，要么是asyn function；这两者都可以直接调用的；</p>
<p>最终添加到<code>middleware</code>数组中。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yacen.github.io/2017/10/17/koa/2017-10-17-koa-Application/" data-id="cjptlhd7j0009cxcp6yz2d4pl" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/koa/">koa</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-koa/2017-10-15-convert" class="article article-type-post" itemscope="" itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/10/15/koa/2017-10-15-convert/" class="article-date">
  <time datetime="2017-10-14T16:00:00.000Z" itemprop="datePublished">2017-10-15</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/nodejs/">nodejs</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/10/15/koa/2017-10-15-convert/">koa-convert</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="convert"><a href="#convert" class="headerlink" title="convert()"></a>convert()</h2><p>GeneratorFunction 怎么转成普通的function 的呢？<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">convert</span> (<span class="params">mw</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> mw !== <span class="string">'function'</span>) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">TypeError</span>(<span class="string">'middleware must be a function'</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (mw.constructor.name !== <span class="string">'GeneratorFunction'</span>) &#123;</span><br><span class="line">    <span class="comment">// assume it's Promise-based middleware</span></span><br><span class="line">    <span class="keyword">return</span> mw</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> converted = <span class="function"><span class="keyword">function</span> (<span class="params">ctx, next</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> co.call(ctx, mw.call(ctx, createGenerator(next)))</span><br><span class="line">  &#125;</span><br><span class="line">  converted._name = mw._name || mw.name</span><br><span class="line">  <span class="keyword">return</span> converted</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> * <span class="title">createGenerator</span> (<span class="params">next</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">yield</span> next()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>首先判断<code>mw</code> 是否是function,不是就抛异常</p>
<p>然后判断<code>mw</code>是否是 GeneratorFunction， 不是就返回原函数。</p>
<p>走到这里就代表<code>mw</code> 就是 GeneratorFunction，定义普通函数 <code>converted</code> ，在 <code>converted</code> 里面就调用了 <code>return co.call(ctx, mw.call(ctx, createGenerator(next)))</code></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yacen.github.io/2017/10/15/koa/2017-10-15-convert/" data-id="cjptlhd7f0006cxcp9v82mfi5" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/koa/">koa</a></li></ul>

    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    
    <a class="extend prev" rel="prev" href="/page/3/">&laquo; Prev</a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><span class="page-number current">4</span><a class="page-number" href="/page/5/">5</a><a class="page-number" href="/page/6/">6</a><span class="space">&hellip;</span><a class="page-number" href="/page/11/">11</a><a class="extend next" rel="next" href="/page/5/">Next &raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Mysql/">Mysql</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Nginx/">Nginx</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/egg/">egg</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/mongodb/">mongodb</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/nodejs/">nodejs</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/nodejs-yaml/">nodejs yaml</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/redis/">redis</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/request/">request</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/koa/">koa</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/lodash/">lodash</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/nodejs/">nodejs</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/koa/" style="font-size: 15px;">koa</a> <a href="/tags/lodash/" style="font-size: 20px;">lodash</a> <a href="/tags/nodejs/" style="font-size: 10px;">nodejs</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/11/">November 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/09/">September 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/08/">August 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/07/">July 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/06/">June 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/05/">May 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/04/">April 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/03/">March 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/02/">February 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/10/">October 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/07/">July 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/07/">July 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/07/">July 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/06/">June 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/05/">May 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/04/">April 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/03/">March 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/12/">December 2014</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/08/">August 2014</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/07/">July 2014</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/06/">June 2014</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2018/11/28/egg/egg-特性/">(no title)</a>
          </li>
        
          <li>
            <a href="/2018/09/20/nginx/2018-09-20-Nginx错误之13Permission denied/">Nginx错误之13:Permission denied</a>
          </li>
        
          <li>
            <a href="/2018/09/12/nginx/2018-09-12-Nginx性能优化之Keep-Alive/">Nginx性能优化之Keep-Alive</a>
          </li>
        
          <li>
            <a href="/2018/09/09/nginx/2018-09-09-Nginx性能优化之Buffers/">Nginx性能优化之Buffers</a>
          </li>
        
          <li>
            <a href="/2018/09/04/nginx/2018-09-04-Nginx性能优化之超时/">Nginx性能优化之超时</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2018 Jax<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>



  </div>
</body>
</html>